<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>压缩机效率计算器 (CoolProp)</title>
    <!-- 加载 Tailwind CSS 以实现现代化样式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 增加输入框的默认垂直间距 */
        .input-group {
            margin-bottom: 0.75rem; /* 12px */
        }
        /* 修正 Tailwind form-radio 的默认样式 */
        input[type="radio"] {
            margin-top: -0.1rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">压缩机性能计算器</h1>

        <div class="bg-white shadow-xl rounded-lg p-6 sm:p-8">
            
            <!-- 输入表单 -->
            <form id="calc-form">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">1. 输入参数</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <!-- 左侧：工质和压缩机 -->
                    <div>
                        <fieldset class="border p-4 rounded-lg mb-4">
                            <legend class="font-medium px-2">工质与压缩机</legend>
                            
                            <!-- 更改 1: 制冷剂下拉菜单 -->
                            <div class="input-group">
                                <label for="fluid" class="block text-sm font-medium text-gray-700 mb-1">制冷剂</label>
                                <select id="fluid" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                                    <option value="R134a" selected>R134a</option>
                                    <option value="R245fa">R245fa</option>
                                    <option value="R1233zd(E)">R1233zd(E)</option>
                                    <option value="R1234ze(E)">R1234ze(E)</option>
                                    <option value="R515B">R515B</option>
                                    <option value="R123">R123</option>
                                    <option value="R22">R22</option>
                                    <option value="R410A">R410A</option>
                                    <option value="R32">R32</option>
                                    <option value="R290">R290</option>
                                    <option value="R717">R717 (Ammonia)</option>
                                </select>
                            </div>
                            
                            <!-- 更改 3: 理论输气量模式 (已修改) -->

                            <div class="input-group">
                                <label for="rpm" class="block text-sm font-medium text-gray-700 mb-1">压缩机转速 (RPM)</label>
                                <input type="number" id="rpm" value="3000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>

                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">理论输气量模式</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="flow_mode" id="flow_mode_rpm" value="rpm" class="form-radio" checked>
                                        <span class="ml-2">按转速与排量</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="flow_mode" id="flow_mode_vol" value="vol" class="form-radio">
                                        <span class="ml-2">按体积流量</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 模式1: 转速与排量 -->
                            <div id="rpm-inputs">
                                <div class="input-group">
                                    <label for="displacement" class="block text-sm font-medium text-gray-700 mb-1">每转排量 (cm³)</label>
                                    <input type="number" id="displacement" value="500" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </div>

                            <!-- 模式2: 体积流量 -->
                            <div id="vol-inputs" style="display: none;">
                                <div class="input-group">
                                    <label for="flow_m3h" class="block text-sm font-medium text-gray-700 mb-1">理论体积流量 (m³/h)</label>
                                    <input type="number" id="flow_m3h" value="100" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="border p-4 rounded-lg mb-4">
                             <legend class="font-medium px-2">功率与容量</legend>
                            <div class="input-group">
                                <label for="capacity" class="block text-sm font-medium text-gray-700 mb-1">制冷量 (kW)</label>
                                <input type="number" id="capacity" value="50" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <!-- 更改 4: 功率模式 -->
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">功率模式</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="power_mode" id="power_mode_shaft" value="shaft" class="form-radio" checked>
                                        <span class="ml-2">轴功率</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="power_mode" id="power_mode_input" value="input" class="form-radio">
                                        <span class="ml-2">输入功率 (电机)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group">
                                <label for="power" id="power-label" class="block text-sm font-medium text-gray-700 mb-1">轴功率 (kW)</label>
                                <input type="number" id="power" value="12" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </fieldset>
                    </div>

                    <!-- 右侧：热力学工况 -->
                    <div>
                        <fieldset class="border p-4 rounded-lg mb-4">
                            <legend class="font-medium px-2">热力学工况</legend>
                            <div class="input-group">
                                <label for="temp_evap" class="block text-sm font-medium text-gray-700 mb-1">蒸发温度 (°C)</label>
                                <input type="number" id="temp_evap" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <div class="input-group">
                                <label for="temp_cond" class="block text-sm font-medium text-gray-700 mb-1">冷凝温度 (°C)</label>
                                <input type="number" id="temp_cond" value="50" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <div class="input-group">
                                <label for="superheat" class="block text-sm font-medium text-gray-700 mb-1">有效过热度 (K)</label>
                                <input type="number" id="superheat" value="10" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>

                            <div class="input-group">
                                <label for="subcooling" class="block text-sm font-medium text-gray-700 mb-1">过冷度 (K)</label>
                                <input type="number" id="subcooling" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="mt-4 text-center">
                    <button type="submit" id="calc-button" class="w-full md:w-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out" disabled>
                        正在加载物性库...
                    </button>
                </div>
            </form>

            <!-- 结果显示 -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">2. 计算结果</h2>
                <!-- 更改 2: 结果区背景色 -->
                <pre id="results" class="bg-gray-50 text-gray-900 p-6 rounded-lg shadow-inner overflow-x-auto min-h-[200px] font-mono text-sm">
--- 请输入参数并点击计算 ---
--- 确保 coolprop.js 和 coolprop.wasm 与此 html 文件在同一文件夹中 ---
--- 并且, 您必须通过本地服务器 (如 VSCode "Go Live") 运行此文件, 否则 .wasm 可能加载失败 ---
                </pre>
            </div>

        </div> <!-- end card -->
    </div> <!-- end container -->


    <!-- JavaScript 逻辑 -->
    <script type="module">
        // 1. 导入 CoolProp 模块
        // 假设 coolprop.js 和 coolprop.wasm 在同一目录下
        import Module from './coolprop.js';

        let CP; // 全局变量，用于持有 CoolProp 实例
        const calcButton = document.getElementById('calc-button');
        const resultsDiv = document.getElementById('results');
        const calcForm = document.getElementById('calc-form');

        // 新增: UI 切换元素
        const flowModeRadios = document.querySelectorAll('input[name="flow_mode"]');
        const rpmInputs = document.getElementById('rpm-inputs');
        const volInputs = document.getElementById('vol-inputs');
        const flowM3hInput = document.getElementById('flow_m3h');
        const displacementInput = document.getElementById('displacement');
        const rpmInput = document.getElementById('rpm'); // RPM 输入框现在是独立的

        const powerModeRadios = document.querySelectorAll('input[name="power_mode"]');
        const powerLabel = document.getElementById('power-label');


        // 2. 异步初始化物性库
        async function initializeCoolProp() {
            try {
                resultsDiv.textContent = "--- 正在加载物性库 (coolprop.js & coolprop.wasm)... ---";
                CP = await Module();
                
                resultsDiv.textContent = "--- 物性库加载成功，请输入参数并点击计算 ---";
                calcButton.disabled = false;
                calcButton.textContent = "计算效率";

            } catch (err) {
                resultsDiv.textContent = `物性库加载失败: ${err.message}\n\n请检查文件路径是否正确，并确保使用本地服务器 (http://) 运行。`;
                console.error(err);
            }
        }

        // --- 新增: UI 切换逻辑 (更改 3 & 4) ---
        flowModeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'rpm') {
                    rpmInputs.style.display = 'block';
                    volInputs.style.display = 'none';
                    // 动态设置表单验证
                    displacementInput.required = true;
                    flowM3hInput.required = false;
                } else {
                    rpmInputs.style.display = 'none';
                    volInputs.style.display = 'block';
                    displacementInput.required = false;
                    flowM3hInput.required = true;
                }
                // RPM 转速输入框 (rpmInput) 始终是必需的，不受切换影响
            });
        });

        powerModeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'shaft') {
                    powerLabel.textContent = '轴功率 (kW)';
                } else {
                    powerLabel.textContent = '输入功率 (kW) (电机)';
                }
            });
        });
        // --- UI 切换逻辑结束 ---


        // 3. 绑定表单提交事件
        calcForm.addEventListener('submit', (event) => {
            event.preventDefault(); // 阻止表单默认提交
            if (!CP) {
                resultsDiv.textContent = "物性库未加载，请刷新页面。";
                return;
            }
            calculate();
        });

        // 4. 主计算函数 (已更新以处理新逻辑)
        function calculate() {
            try {
                // --- A. 获取所有输入值 ---
                const fluid = document.getElementById('fluid').value;
                // 新增: 获取模式
                const flow_mode = document.querySelector('input[name="flow_mode"]:checked').value;
                const power_mode = document.querySelector('input[name="power_mode"]:checked').value;

                // 获取 RPM (现在是共享的)
                const rpm_val = parseFloat(document.getElementById('rpm').value);
                if (isNaN(rpm_val)) throw new Error("请输入有效的压缩机转速 (RPM)。");

                const Qe_kW = parseFloat(document.getElementById('capacity').value);
                const Win_kW = parseFloat(document.getElementById('power').value);
                const Te_C = parseFloat(document.getElementById('temp_evap').value);
                const Tc_C = parseFloat(document.getElementById('temp_cond').value);
                const dT_sh_K = parseFloat(document.getElementById('superheat').value);
                const dT_sc_K = parseFloat(document.getElementById('subcooling').value);

                // 检查无效输入
                if (isNaN(Qe_kW) || isNaN(Win_kW) || isNaN(Te_C) || isNaN(Tc_C) || isNaN(dT_sh_K) || isNaN(dT_sc_K)) {
                    throw new Error("输入包含无效数字，请检查热力学工况、功率或容量字段。");
                }

                // --- B. 单位转换 (CoolProp 使用 SI 单位) ---
                const Te_K = Te_C + 273.15;
                const Tc_K = Tc_C + 273.15;
                const Qe_W = Qe_kW * 1000;
                const Win_W = Win_kW * 1000;
                
                // 理论体积流量 (m³/s) - 根据模式计算 (更改 3)
                let V_th_m3_s;
                let V_rev_cm3_val = NaN, V_th_m3_h_val = NaN;

                if (flow_mode === 'rpm') {
                    V_rev_cm3_val = parseFloat(document.getElementById('displacement').value);
                    if (isNaN(V_rev_cm3_val)) throw new Error("请检查每转排量输入。");
                    if (rpm_val <= 0) throw new Error("转速必须大于 0 才能计算体积流量。");
                    
                    V_th_m3_s = (V_rev_cm3_val / 1e6) * (rpm_val / 60);
                    // 额外计算 m³/h 用于显示
                    V_th_m3_h_val = V_th_m3_s * 3600;

                } else { // flow_mode === 'vol'
                    V_th_m3_h_val = parseFloat(document.getElementById('flow_m3h').value);
                    if (isNaN(V_th_m3_h_val)) throw new Error("请检查体积流量输入。");
                    if (rpm_val <= 0) throw new Error("转速必须大于 0 才能计算每转排量。");

                    V_th_m3_s = V_th_m3_h_val / 3600; // m³/h -> m³/s
                    // 额外反算 cm³/rev 用于显示
                    V_rev_cm3_val = (V_th_m3_s * 60 / rpm_val) * 1e6;
                }


                // --- C. 计算热力学状态点 (SI 单位) ---

                // 状态点 1 (压缩机入口)
                const T1_K = Te_K + dT_sh_K;
                const Pe_Pa = CP.PropsSI('P', 'T', Te_K, 'Q', 1, fluid); // 蒸发压力 (Pa)
                const h1_J_kg = CP.PropsSI('H', 'T', T1_K, 'P', Pe_Pa, fluid); // 焓 (J/kg)
                const s1_J_kgK = CP.PropsSI('S', 'T', T1_K, 'P', Pe_Pa, fluid); // 熵 (J/kg·K)
                const rho1_kg_m3 = CP.PropsSI('D', 'T', T1_K, 'P', Pe_Pa, fluid); // 密度 (kg/m³)
                const v1_m3_kg = 1 / rho1_kg_m3; // 比容 (m³/kg)

                // 状态点 3 (膨胀阀入口)
                const T3_K = Tc_K - dT_sc_K;
                const Pc_Pa = CP.PropsSI('P', 'T', Tc_K, 'Q', 0, fluid); // 冷凝压力 (Pa)
                const h3_J_kg = CP.PropsSI('H', 'T', T3_K, 'P', Pc_Pa, fluid); // 焓 (J/kg)

                // 状态点 4 (蒸发器入口)
                const h4_J_kg = h3_J_kg; // 等焓膨胀

                // 状态点 2s (等熵压缩出口)
                const h2s_J_kg = CP.PropsSI('H', 'P', Pc_Pa, 'S', s1_J_kgK, fluid); // 等熵焓 (J/kg)

                // --- D. 计算性能参数 ---

                // 1. 质量流量 (kg/s)
                const h_evap_J_kg = h1_J_kg - h4_J_kg; // 蒸发器焓差
                if (h_evap_J_kg <= 0) {
                    throw new Error("计算出错：制冷焓差小于等于零。");
                }
                const m_dot_kg_s = Qe_W / h_evap_J_kg;

                // 2. 等熵功率 (W)
                const h_isen_J_kg = h2s_J_kg - h1_J_kg; // 等熵压缩焓升
                const Ws_W = m_dot_kg_s * h_isen_J_kg;

                // 3. 实际入口体积流量 (m³/s)
                const V_actual_m3_s = m_dot_kg_s * v1_m3_kg;

                // --- E. 计算效率 ---

                // 1. 等熵效率
                if (Win_W <= 0) {
                    throw new Error("输入功率必须大于零。");
                }
                const eta_s = (Ws_W / Win_W); // 核心计算 (Ws / W_provided)

                // 2. 容积效率
                if (V_th_m3_s <= 0) {
                    throw new Error("理论排量必须大于零。");
                }
                const eta_v = (V_actual_m3_s / V_th_m3_s);

                // --- F. 格式化输出 (已更新 更改 3 & 4) ---
                
                // 确定效率标签
                const efficiencyLabel = (power_mode === 'shaft') ? 
                    `等熵效率 (η_s = Ws / W_shaft)` : 
                    `总等熵效率 (η_total = Ws / W_in)`;
                
                const powerInputLabel = (power_mode === 'shaft') ? 
                    `轴功率 (Win)` : 
                    `输入功率 (Win)`;

                let output = `
--- 计算概览 (工质: ${fluid}) ---
蒸发压力 (Pe): ${(Pe_Pa / 1e5).toFixed(3)} bar
冷凝压力 (Pc): ${(Pc_Pa / 1e5).toFixed(3)} bar
压缩比 (PR):   ${(Pc_Pa / Pe_Pa).toFixed(2)}

--- 关键状态点 ---
状态 1 (入口):
  T1 = ${T1_K.toFixed(2)} K (${(T1_K - 273.15).toFixed(2)} °C)
  h1 = ${(h1_J_kg / 1000).toFixed(2)} kJ/kg
  s1 = ${(s1_J_kgK / 1000).toFixed(4)} kJ/kg·K
  v1 = ${v1_m3_kg.toFixed(5)} m³/kg

状态 3 (阀前):
  T3 = ${T3_K.toFixed(2)} K (${(T3_K - 273.15).toFixed(2)} °C)
  h3 = ${(h3_J_kg / 1000).toFixed(2)} kJ/kg

状态 2s (等熵出口):
  h2s = ${(h2s_J_kg / 1000).toFixed(2)} kJ/kg

--- 流量与功率 ---
制冷焓差:     ${(h_evap_J_kg / 1000).toFixed(2)} kJ/kg
质量流量 (m_dot): ${m_dot_kg_s.toFixed(5)} kg/s
等熵功率 (Ws):   ${(Ws_W / 1000).toFixed(3)} kW
${powerInputLabel}: ${Win_kW.toFixed(3)} kW

--- 体积流量 (转速: ${rpm_val.toFixed(0)} RPM) ---
`;

                // 根据模式显示不同的输入/计算结果
                if (flow_mode === 'rpm') {
                    output += `输入排量:     ${V_rev_cm3_val.toFixed(1)} cm³/rev\n`;
                    output += `计算流量:     ${V_th_m3_h_val.toFixed(2)} m³/h\n`;
                } else {
                    output += `输入流量:     ${V_th_m3_h_val.toFixed(2)} m³/h\n`;
                    output += `计算排量:     ${V_rev_cm3_val.toFixed(1)} cm³/rev\n`;
                }

                output += `
理论体积流量 (V_th): ${V_th_m3_s.toFixed(6)} m³/s
实际体积流量 (V_act): ${V_actual_m3_s.toFixed(6)} m³/s

========================================
           最终效率计算
========================================
${efficiencyLabel}: ${(eta_s * 100).toFixed(2)} %
容积效率 (η_v = V_act / V_th):       ${(eta_v * 100).toFixed(2)} %
`;
                resultsDiv.textContent = output;

            } catch (error) {
                // 捕获物性计算或逻辑错误
                resultsDiv.textContent = `计算出错: ${error.message}\n\n请检查输入参数是否在工质的有效范围内。`;
                console.error(error);
            }
        }

        // 5. 页面加载时，禁用按钮并开始初始化
        calcButton.disabled = true;
        initializeCoolProp();

    </script>

</body>
</html>